---
title: "Spatial Assignment 3"
author: "Jack Halverson"
date: "9/21/2021"
output: html_document
---

```{r}
library(sf)
library(tidyverse)
library(ggthemes)
library(ggspatial)
library(units)
library(nngeo)
```

# Load and transform data
```{r}
cultural <- st_read("https://data.sfgov.org/api/geospatial/5xmc-5bjj?method=export&format=KML")
planning <- st_read("https://data.sfgov.org/api/geospatial/ttns-6zj3?method=export&format=KML")
art <- st_read("https://data.sfgov.org/api/geospatial/cf6e-9e4j?method=export&format=KML")
murals <- st_read("https://data.sfgov.org/api/geospatial/wg8w-68vc?method=export&format=KML")

CA_zone_3 <- "+proj=lcc +lat_1=38.43333333333333 +lat_2=37.06666666666667 +lat_0=36.5 +lon_0=-120.5 +x_0=2000000 +y_0=500000 +ellps=GRS80 +units=m +no_defs "

cultural <- cultural %>%
  st_transform(CA_zone_3)

planning <- planning %>%
  st_transform(CA_zone_3)

art <- art %>%
  st_transform(CA_zone_3)

murals <- murals %>%
  st_transform(CA_zone_3)
```

# Number and proportion of 1% art projects near Murals
```{r}
murals_buffer <- st_buffer(murals, dist = 400) %>%
  st_union()

ggplot(murals_buffer) +
  geom_sf() +
  theme_map()


art_murals<- art[murals_buffer,]
  
ggplot(murals_buffer) +
  geom_sf() +
  geom_sf(data = art_murals, 
          color = "darkgreen", 
          size = 0.01) +
  theme_map()


art <- art %>%
  st_join(art_murals) %>%
  mutate(by_murals = !is.na(Description.y))


n_murals_art <- sum(art$by_murals)

n_murals_art


n_art <- length(art$by_murals)

pct_murals_art <- n_murals_art / n_art

pct_murals_art


left_side  <- st_bbox(planning)$xmin
top_side <- st_bbox(planning)$ymax

ggplot() +
  geom_sf(data = planning, fill = "light gray", color = "black") +
  geom_sf(data = art, size = 1,
          aes(color = by_murals)) +
  scale_color_manual(values = c("red", "blue"),
          name = "San Francisco 1% Art Projects \nby distance to a StreetSmArts Mural", 
          labels = c("No StreetSmArts Mural within 400 m",
                     "StreetSmArts Mural within 400 m")) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_minimal()) +
  annotate(geom = "text", x = left_side, 
           y = top_side,
           label = paste("Of the ", 
                         prettyNum(n_art, big.mark = ","),
                         " 1% Art Projects in San Francisco\n", 
                         prettyNum(n_murals_art, big.mark = ","),
                         " (", 
                         prettyNum(100*pct_murals_art, digits = 0),
                         "%) are within 400\nmeters of a StreetSmArts Mural.",
                         sep = ""),
           hjust = 0, vjust = 1, size = 3) +
  theme_map() +
  theme(panel.background = element_rect(fill = "cornsilk1"),
        legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))
```


# Number and proportion of Murals near 1% art projects
```{r}
art_buffer <- st_buffer(art, dist = 400) %>%
  st_union()

ggplot(art_buffer) +
  geom_sf() +
  theme_map()


murals_art <- murals[art_buffer,]
  
ggplot(art_buffer) +
  geom_sf() +
  geom_sf(data = murals_art, 
          color = "darkgreen", 
          size = 0.01) +
  theme_map()


murals <- murals %>%
  st_join(murals_art) %>%
  mutate(by_art = !is.na(Name.y))

n_art_murals <- sum(murals$by_art)

n_art_murals


n_murals <- length(murals$by_art)

pct_art_murals <- n_art_murals / n_murals

pct_art_murals


left_side  <- st_bbox(planning)$xmin
top_side <- st_bbox(planning)$ymax

ggplot() +
  geom_sf(data = planning, fill = "light gray", color = "black") +
  geom_sf(data = murals, size = 1,
          aes(color = by_art)) +
  scale_color_manual(values = c("red", "blue"),
          name = "Boston Murals\nby distance to a parking meter", 
          labels = c("No 1% Art within 30 m",
                     "1% Art within 30 m")) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_minimal()) +
  annotate(geom = "text", x = left_side, 
           y = top_side, 
           label = paste("Of the ", 
                         prettyNum(n_murals, big.mark = ","),
                         " trees in Boston\n", 
                         prettyNum(n_art_murals, big.mark = ","),
                         " (", 
                         prettyNum(100*pct_art_murals, digits = 0),
                         "%) are within 30\nmeters of 1% art.",
                         sep = ""),
           hjust = 0, vjust = 0, size = 3) +
  theme_map() +
  theme(panel.background = element_rect(fill = "cornsilk1"),
        legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))
```


# Number of 1% Art Projects in Planning Districts
```{r}
planning <- planning %>%
  mutate(num_art = lengths(st_covers(planning, art)))

ggplot(planning) +
  geom_sf(color = NA, 
          aes(fill = num_art)) +
  scale_fill_viridis_c(name = "San Francisco planning districts\nby number of 1% Art Projects",
                       breaks = breaks <- seq(0, 50, by = 10),
                       labels = paste(prettyNum(breaks, big.mark = ","),
                                      "art projects")) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_minimal()) +
theme_map() +
  theme(legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))
```


# Number of Murals in Planning Districts
```{r}
planning <- planning %>%
  mutate(num_murals = lengths(st_covers(planning, murals)))

ggplot(planning) +
  geom_sf(color = NA, 
          aes(fill = num_murals)) +
  scale_fill_viridis_c(name = "San Francisco planning districts\nby number of 1% Art Projects",
                       breaks = breaks <- seq(0, 50, by = 10),
                       labels = paste(prettyNum(breaks, big.mark = ","),
                                      "murals")) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_minimal()) +
theme_map() +
  theme(legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))
```
# Number of Murals in Cultural Districts
```{r}
cultural <- cultural %>%
  mutate(num_murals = lengths(st_covers(cultural, murals)))

ggplot() +
  geom_sf(data = planning, fill = "light gray", color = "black") +
  geom_sf(data = cultural, color = NA, 
          aes(fill = num_murals)) +
  scale_fill_viridis_c(name = "San Francisco planning districts\nby number of 1% Art Projects",
                       breaks = breaks <- seq(0, 10, by = 2),
                       labels = paste(prettyNum(breaks, big.mark = ","),
                                      "murals")) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_minimal()) +
theme_map() +
  theme(legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))
```


# Number of 1% Art Projects in Cultural Districts
```{r}
cultural <- cultural %>%
  mutate(num_art = lengths(st_covers(cultural, art)))

ggplot() +
  geom_sf(data = planning, fill = "light gray", color = "black") +
  geom_sf(data = cultural, color = NA, 
          aes(fill = num_art)) +
  geom_sf(data = art, size = 1, color = "red") +
  scale_fill_viridis_c(name = "San Francisco planning districts\nby number of 1% Art Projects",
                       breaks = breaks <- seq(0, 15, by = 10),
                       labels = paste(prettyNum(breaks, big.mark = ","),
                                      "art")) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_minimal()) +
theme_map() +
  theme(legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))
```




# Number and proportion of Planning Districts that have Cultural Districts
```{r}
planning <- planning %>%
  mutate(num_cultural = lengths(st_overlaps(planning, cultural))) %>%
  mutate(has_cultural = num_cultural > 0)

n_cultural_planning <- sum(planning$has_cultural)

n_cultural_planning


left_side  <- st_bbox(cultural)$xmin
top_side <- st_bbox(cultural)$ymax

ggplot(cultural) +
  geom_sf(fill = "lightblue", color = NA) +
  geom_sf(data = planning,
          aes(fill = has_cultural)) +
  scale_fill_manual(values = c("cornsilk1", "darkseagreen1"),
          name = "Boston Neighborhoods\nby presence of Cultural Districts", 
          labels = c("Neighborhood without\na Cultural District",
                     "Neighborhood with an\n Cultural District")) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_minimal()) +
  annotate(geom = "text", x = left_side, 
           y = top_side - 1000, 
           label = paste(n_cultural_planning ,
                         "of San Francisco's", 
                         length(planning$Name),
                         "Planning Districts contain\nor overlap with", 
                         "Cultural Districts."),
           hjust = 0, vjust = 0, size = 3) +
  theme_map() +
  theme(panel.background = element_rect(fill = "gray"),
        legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))

```







# Density of 1% art in Planning Districts
```{r}
planning <- planning %>%
  mutate(area = set_units(st_area(planning), km^2)) %>%
  mutate(art_dens = as.numeric(num_art / area))

ggplot(planning) +
  geom_sf(color = NA, 
          aes(fill = art_dens)) +
    scale_fill_viridis_c(name =
                           "San Francisco Planning Districts\nby 1% Art density",
                       breaks = breaks <- seq(0, 10, by = 5),
                       labels = paste(prettyNum(breaks, big.mark = ","),
                                      "1% Art Projects per square km")) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_minimal()) +
theme_map() +
  theme(legend.position = "right",
    legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))
```
# Density of Murals in Planning Districts
```{r}
planning <- planning %>%
  mutate(area = set_units(st_area(planning), km^2)) %>%
  mutate(murals_dens = as.numeric(num_murals / area))

ggplot(planning) +
  geom_sf(color = NA, 
          aes(fill = murals_dens)) +
    scale_fill_viridis_c(name =
                           "San Francisco Planning Districts\nby Murals density",
                       breaks = breaks <- seq(0, 5, by = 1),
                       labels = paste(prettyNum(breaks, big.mark = ","),
                                      "Murals per square km")) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_minimal()) +
theme_map() +
  theme(legend.position = "right",
    legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))
```


# Average distance of 1% Art projects from Murals


# Average distance of Murals from 1% Art projects
```{r}
murals <- murals %>%
  mutate(art_dist = st_nn(murals, art, 
                           returnDist = TRUE)$dist) %>%
  mutate(art_dist = as.numeric(art_dist))


avg_art_dist <- mean(murals$art_dist)

avg_art_dist


right_side <- st_bbox(planning)$xmax
left_side  <- st_bbox(planning)$xmin
top_side <- st_bbox(planning)$ymax
bottom_side <- st_bbox(planning)$ymin


ggplot(planning) +
  geom_sf(fill = "lightblue", color = NA) +
  geom_sf(data = murals, size = 1,
          aes(color = art_dist)) +
  coord_sf(xlim = c(left_side, right_side), 
           ylim = c(bottom_side, top_side), expand = FALSE) +
  scale_color_viridis_c(name = 
                          "San Francisco Murals\nby distance to a 1% Art Project") +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_minimal()) +
  annotate(geom = "text", x = left_side + 300, 
           y = top_side - 550, 
           label = paste("On average, a San Francisco Mural\nis ", 
                         prettyNum(avg_art_dist, digits = 3),
                         " meters from a 1% Art Project.",
                         sep = ""),
           hjust = 0, vjust = 2, size = 3) +
  theme_map() +
  theme(panel.background = element_rect(fill = "cornsilk1"),
        legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))
```